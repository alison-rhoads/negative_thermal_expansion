**1. DFT Relaxation [VASP]**
  
  The following files are needed for the DFT relaxation:
  POTCAR: contains the pseudopotential for each atomic species in the same order as in the POSCAR. The order is very important. We obtained this file by concatenating the default pseudopotentials provided by VASP (these are currently located in /scratch/arhoads/POTCARs) for Sc_sv followed by F 
  
  ORDER MATTERS
  cat /scratch/arhoads/POTCARs/POT_PAW_PBE_64/Cu/POTCAR /scratch/arhoads/POTCARs/POT_PAW_PBE_64/O/POTCAR > POTCAR
  
  cat /scratch/arhoads/POTCARs/POT_PAW_PBE_64/Zr_sv/POTCAR /scratch/arhoads/POTCARs/POT_PAW_PBE_64/W_sv/POTCAR  /scratch/arhoads/POTCARs/POT_PAW_PBE_64/O/POTCAR > POTCAR
  POSCAR: specifies lattice geometry and ionic positions. We obtained the POSCAR from MP listing for cubic ScF_3.
  
  Once you have this POSCAR run phonopy --symmetry  to generate the primitive poscar (PPOSCAR) and rename to POSCAR
  
  
  INCAR: central input file specifying what is to be done and how. (Ps = PBESol, KSPACING = 0.25 (in the past was 0.3 and 0.15. All future calcs must use 0.25)
  
  
  KPOINTS: specifies the Bloch vectors (k points) used to sample the Brillouin zone. If KSPACING is specified in INCAR, then the KPOINTS file IS NOT NEEDED
  
  
  run.sh: job script to submit on HPC

Prep Files:
phonopy --symmetry
mv POSCAR MP-POSCAR
mv PPOSCAR POSCAR
vi POSCAR
cat /scratch/arhoads/POTCARs/POT_PAW_PBE_64/ELEM/POTCAR /scratch/arhoads/POTCARs/POT_PAW_PBE_64/ELEM/POTCAR > POTCAR
mkdir 0-prep
mv * 0-prep/

Using VASP with PBEsol we conduct a DFT relaxation. The relaxation consists of two nested loops. 
Minimize the residual forces between the atoms by adjusting positions. Threshold (EDIFFG) = -1E-4. Since the threshold is negative, the relaxation stops when the norms of forces are less than the absolute value of EDIFFG
Within the force optimization is a traditional DFT self-consistent cycle to minimize the energy by adjusting the electron density. Once this step converges (we selected a threshold (EDIFF) of 1E-8) then we proceed to the next step in the DFT relaxation.

Notes: 
used a clean INCAR that was generated by atomate2 from HS. 
The final structure is stored in CONTCAR
Successful relaxations with this input were performed in /scratch/arhoads/ScF3/relax/ht_incar
Started out with a coarser 1E-7 mesh and then made it finer to 1E-8 s.t. the forces would converge. 

**2. Obtain Phonon Modes [phonopy]**

Idea: use phonopy to get harmonic phonon modes and check if they are all real. If they are not, then we must renormalize. Since this is a simple material ( i.e. high symmetry/cubic and low number of sites) we can use phonopy. 

Preparation
First, we created a conda environment with python 3.12.4 (env called py3124) and installed phonopy (pip install phonopy).

Next we must perform some transformations. All transformations are done with phonopy. 

Copy CONTAR from the relaxation into the static calc directory as POSCAR.

Make a supercell with three primitive cells in each direction (~ 12^3 in volume) and generate small displaced configurations using phonopy. Both are done with the following command. Four displacements were generated 

``phonopy -d --dim 3 3 3 --pa auto``

Static Calculation
For each of these displaced configurations, we perform a static calculation. This means that ONLY the electronic SC-loop takes place, that is there is no minimization of residual forces and no change in ionic positions, only changes in electron density. The static calculation differs from the relaxation step ONLY in the INCAR file. NSW parameter sets the max number of ionic steps, so by setting NSW = 0, relaxation does not take place. With Kspacing = 0.25, the standard queue was needed. All jobs completed in under 3 hours.  

Note: in the static directory to do all the force constant stuff you need phonopy_disp.yaml

Idea:
Force constants are calculated from the sets of forces
A part of dynamical matrix is built from the force constants
Phonon frequencies and eigenvectors are calculated from the dynamical matrices with the specified q-points.

**Get harmonic phonon modes**

``phonopy -f {001..002}/vasprun.xml 	                          # generates force sets. 
phonopy --writefc phonopy_disp.yaml	                          # generates compressed FCs
phonopy --writefc phonopy_disp.yaml --full-fc --hdf5      # full force constants``

**Calculate Dielectric Constant**

Carried out in /scratch/arhoads/ScF3/dielectric 
After submitting the DFT calculation do: phonopy-vasp-born > BORN

**Generate Band Structure and DOS**

``phonopy --dim 4 4 3 --readfc --band auto -ps --nac
phonopy-load --mesh 20 20 20 --dos -ps
phonopy-load --mesh 20 20 20 --pdos "1 2 3 4, 5 6" -ps    # nums = atom idx ``


Note: bandstructure is saved in band.pdf

**3. Anharmonic Force Constants and Fitting**

Note: all force constants MUST be FULL force constants
``pheasy -f --read_scell --dim 3 3 3 -w 4 --fix_fc2 --hdf5 --full_ifc``
Apply SAME procedure as above, except this time we generate new displaced configurations. There will be more based on the number of unique sensing matrix elements. Apply static calculations to these:

phonopy --amplitude 0.08 --rd 50 --dim 3 3 3 --random-seed 1    

If running locally, this environment works for the following steps:
conda create -n py310 python=3.10 numpy=1.24 scipy=1.10

Once you have all static calculations done:

``1. bash copy_force_constants_and_anharmonic.sh to get a new directory with all displaced POSCARs and vasprun.xmls labelled
2. do phonopy -f disp-{001..003}/vasprun.xml --hdf5 --full_fc to get the full harmonic force constants in hdf5 file format
3. Python python make_matrices_wo_residual_forces.py``

Then proceed to the following pheasy commands:

``pheasy -s --dim 4 4 3 -w 3 --c3 5 --nbody 2 3 --ndata 50 
pheasy -s --read_scell --dim 4 4 3 -w 3 --c3 5 --nbody 2 3 --ndata 50
pheasy -c --read_scell --dim 4 4 3 -w 3 --ndata 50
pheasy -d --read_scell --dim 4 4 3 --ndata 50 --disp_file

pheasy -f --read_scell --dim 4 4 3 -w 3 --model LASSO --ndata 50 --fix_fc2 --hdf5 --full_ifc > fit.out``

**4. Gruneisen calculation**
``conda activate phonopy
phono3py --fc2  --fc3  --dim "4 4 3"  -c POSCAR 
phono3py-load --mesh 20 20 20 --nac ewald --gruneisen``

**5. CTE**
Once you have gruneisen.yaml, simply run cte_calc.py! or use the jupyter notebook
 
**6. Lattice Thermal Conductivity**

``phono3py --dim 3 3 3 --fc2 --fc3 --br --isotope --wigner --mesh 15 15 15 --tmin 10 --tmax 1000 --tstep 58 > 15_ltc.out``

**Renormalization of Harmonic FCs (AIMD Method)**

``pheasy -s --dim 3 3 3 -w 2 --nbody 2
pheasy -c --dim 3 3 3 -w 2
pheasy -d --dim 3 3 3 -w 2 -m AIMD --nskip=1000 --nstep 800 --ndata 5
pheasy -f --dim 3 3 3 -w 2 -m AIMD --nskip 1000 --nstep 800 --ndata 5 -l LASSO --std --full_ifc --rasr BHH --hdf5 > fit.out

phonopy --dim 3 3 3 --readfc --band auto -ps --nac``
